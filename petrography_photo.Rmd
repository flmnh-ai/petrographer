---
title: "Petroscanner"
author: "Ashley Rutkoski"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(magick)
library(ggplot2)
library(tools)

# Define input and output directories
input_dir <- "C:/Users/arutkoski/OneDrive - University of Florida/Gauthieret2024/LindsayNSFtif"
output_dir <- "C:/Users/arutkoski/OneDrive - University of Florida/Gauthieret2024/LindsayNSFjpeg"

# Ensure the output directory exists
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Define slicing dimensions
slice_width <- 529  # Width of each slice in pixels
slice_height <- 529 # Height of each slice in pixels

# Set JPEG quality
jpeg_quality <- 95  # Adjust this value (85-95 is typically high quality)

# Get a list of image files in the input directory
image_files <- list.files(input_dir, pattern = "\\.(png|jpg|jpeg|tiff|tif|bmp|gif)$", full.names = TRUE, ignore.case = TRUE)

# Check if images are found
if (length(image_files) == 0) {
  stop("No image files found in the input directory. Check the folder path and file extensions.")
}

cat("Files found in the input directory:\n")
print(image_files)  # Debugging: print list of files

# Process each image file
for (input_file in image_files) {
  # Extract the base name of the input file (without extension)
  input_basename <- file_path_sans_ext(basename(input_file))
  
  # Debugging: Print the current file being processed
  cat(sprintf("Processing file: %s\n", input_file))
  
  # Read the input image
  img <- tryCatch(
    {
      image_read(input_file)
    },
    error = function(e) {
      cat(sprintf("Error reading file: %s\n", input_file))
      NULL
    }
  )
  
  if (is.null(img)) next  # Skip to the next file if there's an error
  
  # Get image dimensions
  img_info <- image_info(img)
  img_width <- img_info$width
  img_height <- img_info$height
  
  # Initialize variables for mapping
  map_data <- data.frame()
  count <- 1  # Initialize slice numbering
  
  # Slice the image
  for (top in seq(0, img_height - slice_height, by = slice_height)) {
    for (left in seq(0, img_width - slice_width, by = slice_width)) {
      # Define the cropping geometry
      geometry <- sprintf("%dx%d+%d+%d", slice_width, slice_height, left, top)
      
      # Crop the image
      sliced_img <- image_crop(img, geometry)
      
      # Generate output file name based on the original image name
      output_filename <- sprintf("%s_%d.jpeg", input_basename, count)
      output_filepath <- file.path(output_dir, output_filename)
      
      # Debug: Print the filepath
      cat(sprintf("Output file path: %s\n", output_filepath))
      
      # Save the sliced image with high JPEG quality
      tryCatch(
        {
          image_write(
            image_convert(sliced_img, format = "jpeg"), 
            path = output_filepath, 
            format = "jpeg",
            quality = jpeg_quality  # High-quality setting
          )
        },
        error = function(e) {
          cat(sprintf("Error saving slice: %s\n", output_filepath))
        }
      )
      
      # Add data to map visualization
      map_data <- rbind(map_data, data.frame(
        x = left + slice_width / 2,
        y = img_height - (top + slice_height / 2),  # Flip y-axis for plotting
        label = as.character(count)  # Label is just the slice number
      ))
      
      count <- count + 1
    }
  }
  
  # Create the map visualization
  map_plot <- ggplot() +
    geom_rect(data = map_data, aes(xmin = x - slice_width / 2, xmax = x + slice_width / 2, 
                                   ymin = y - slice_height / 2, ymax = y + slice_height / 2),
              fill = NA, color = "blue") +
    geom_text(data = map_data, aes(x = x, y = y, label = label), size = 3) +  # Reduced text size for simplicity
    labs(title = sprintf("Image Slicing Map for %s", input_basename), x = "Pixels", y = "Pixels") +
    coord_fixed() +
    theme_minimal()
  
  # Save the map as a JPEG
  map_output_file <- file.path(output_dir, sprintf("%s_map.jpeg", input_basename))
  tryCatch(
    {
      ggsave(map_output_file, map_plot, width = 8, height = 6, dpi = 300)
    },
    error = function(e) {
      cat(sprintf("Error saving map: %s\n", map_output_file))
    }
  )
  
  cat(sprintf("Processed and mapped: %s\n", input_file))
}

cat("Batch processing completed. All slices and individual maps saved in:", output_dir, "\n")
```


#selecting a sample for annotation 
```{r}
# Load required libraries
library(fs)

# Define source and destination folders
source_folder <- "C:/Users/arutkoski/OneDrive - University of Florida/Gauthieret2024/LindsayNSFjpeg"  # Replace with your source folder path
destination_folder <- "C:/Users/arutkoski/OneDrive - University of Florida/Gauthieret2024/LindsayNSFsubset"  # Replace with your destination folder path

# Ensure the destination folder exists
if (!dir_exists(destination_folder)) {
  dir_create(destination_folder)
}

# List all image files in the source folder
image_files <- dir_ls(source_folder, glob = "*.jpeg") # Adjust glob for other formats like PNG

# Randomly sample 400 images
selected_images <- sample(image_files, 500)

# Copy selected images to the destination folder
file.copy(selected_images, destination_folder)

cat("500 images have been randomly selected and copied to the destination folder.")
```